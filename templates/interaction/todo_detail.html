{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="todoDetail"></div>

<div>
    <button class="todoUpdate">ìˆ˜ì •</button>
    <button class="todoDelete">ì‚­ì œ</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", init);

function init(){
    const pk = getTodoId();
    loadTodoDetail(pk);
    bindUpdateButton(pk);
    bindDeleteButton(pk);
}

function getTodoId(){
    return window.location.pathname.split('/').filter(Boolean).pop();    
}

function loadTodoDetail(pk){
    axiosInstance
    .get(`/todo/viewsets/view/${pk}/`)
    .then(res => renderTodoDetail(res.data))
    .catch(err => console.error('ë¡œë”© ì‹¤íŒ¨:', err));
}

function renderTodoDetail(data){
    const container = document.querySelector(".todoDetail");
    container.innerHTML = `
      <div class="todo-item">
        <p><strong>Name:</strong> ${data.name}</p>
        <p><strong>Description:</strong> ${data.description}</p>
        <p><strong>Complete:</strong> ${data.complete}</p>
        <p><strong>Completed At:</strong> ${datetimeToString(data.completed_at)}</p>
        <p><strong>Experience Points:</strong> ${data.exp}</p>

        <button class="social-btn commentToggleBtn">
            <span class="icon">ğŸ’¬</span>
            <span class="count">${data.comment_count || 0}</span>
        </button>
        <button class="social-btn bookmarkBtn" data-id="${data.id}">
            <span class="icon">ğŸ”–</span>
            <span class="count">${data.bookmark_count ?? 0}</span>
        </button>
        <button class="social-btn likeBtn" data-id="${data.id}">
            <span class="icon">${data.is_liked ? 'ğŸ’”' : 'â¤ï¸'}</span>
            <span class="count">${data.like_count ?? 0}</span>
        </button>
        <button class="social">
            <a href="/interaction/todo/detail/${data.id}/" target="_blank" class="detail-link">MYëŒ“ê¸€</a>
        </button>

        <div class="commentBox" style="display:none;">
            <ul class="commentList"></ul>
            <input type="text" class="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button class="commentSubmit">ë“±ë¡</button>
        </div>
      </div>
    `;

    const div = container.querySelector('.todo-item');

    // ëŒ“ê¸€ ë“±ë¡
    div.querySelector('.commentSubmit').addEventListener('click', e => {
        e.stopPropagation();
        const commentInput = div.querySelector('.commentInput');
        const content = commentInput.value;
        if (content.trim()) {
            postComment(data.id, content);
            commentInput.value = '';
        }
    });

    // ëŒ“ê¸€ í† ê¸€
    div.querySelector('.commentToggleBtn').addEventListener('click', e => {
        e.stopPropagation();
        const commentBox = div.querySelector('.commentBox');
        commentBox.style.display = (commentBox.style.display === 'none') ? 'block' : 'none';
        loadComments(data.id, div.querySelector('.commentList'));
    });

    // ë¶ë§ˆí¬ í† ê¸€
    div.querySelector('.bookmarkBtn')?.addEventListener('click', e => {
        e.stopPropagation();
        toggleBookmark(data.id);
    });

    // ì¢‹ì•„ìš” í† ê¸€
    div.querySelector('.likeBtn')?.addEventListener('click', e => {
        e.stopPropagation();
        toggleLike(data.id);
    });

    // ëŒ“ê¸€ ì…ë ¥ì°½ í´ë¦­ ì‹œ ìƒì„¸í˜ì´ì§€ ì´ë™ ë°©ì§€
    div.querySelector('.commentInput').addEventListener('click', e => e.stopPropagation());
}

function bindUpdateButton(pk){
    const btn = document.querySelector('.todoUpdate');
    if (!btn) return;
    btn.addEventListener('click', () => {
        window.location.href = `/todo/update/${pk}/`;
    });
}

function bindDeleteButton(pk){
    const btn = document.querySelector('.todoDelete');
    if (!btn) return;
    btn.addEventListener('click', () => {
        if (!confirm('ì •ë§ í•´ë‹¹ Todoë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        axiosInstance
            .delete(`/todo/viewsets/view/${pk}/`)
            .then(() => window.location.href = '/todo/list/')
            .catch(() => alert('Todo ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
    });
}

// ëŒ“ê¸€ ë“±ë¡ ìš”ì²­
function postComment(todoId, content) {
    if (!content) return alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");
    axiosInstance.post("/interaction/comments/", { todo_pk: todoId, content: content })
        .then(() => {
            loadComments(todoId, document.querySelector('.commentList'));
        })
        .catch(error => {
            console.error("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:", error.response?.data || error);
            alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:\n" + JSON.stringify(error.response?.data, null, 2));
        });
}

// ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
function loadComments(todoId, listElement) {
    axiosInstance.get(`/interaction/comments/`, { params: { todo_pk: todoId } })
        .then(res => {
            const payload = Array.isArray(res.data) ? res.data :
                            Array.isArray(res.data.results) ? res.data.results :
                            (res.data.data || []);

            listElement.innerHTML = '';
            payload.forEach(c => {
                const li = document.createElement('li');
                li.innerHTML = `${c.username || c.user.username}: ${c.content} 
                    <button class="comment-like-btn" data-id="${c.id}">ğŸ‘ ${c.like_count}</button>`;
                li.querySelector('.comment-like-btn')?.addEventListener('click', e => {
                    e.stopPropagation();
                    toggleCommentLike(c.id);
                });
                listElement.appendChild(li);
            });

            // ëŒ“ê¸€ ìˆ˜ ê°±ì‹ 
            const countEl = document.querySelector('.commentToggleBtn .count');
            if (countEl) countEl.textContent = payload.length;
        })
        .catch(err => console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', err));
}

// ëŒ“ê¸€ ì¢‹ì•„ìš” í† ê¸€
function toggleCommentLike(commentId) {
    axiosInstance.post(`/interaction/commentlikes/${commentId}/toggle/`)
        .then(res => {
            const btn = document.querySelector(`.comment-like-btn[data-id="${commentId}"]`);
            if (btn) btn.innerHTML = `ğŸ‘ ${res.data.like_count}`;
        })
        .catch(err => console.error("ëŒ“ê¸€ ì¢‹ì•„ìš” ì‹¤íŒ¨:", err));
}

// ë¶ë§ˆí¬ í† ê¸€
function toggleBookmark(todoId) {
    axiosInstance.post(`/interaction/bookmarks/${todoId}/toggle/`)
        .then(res => {
            const { is_bookmarked, bookmark_count } = res.data;
            const btn = document.querySelector(`.bookmarkBtn[data-id="${todoId}"]`);
            if (btn) btn.innerHTML = `ğŸ”– <span class="count">${bookmark_count}</span>`;
        })
        .catch(err => console.error("ë¶ë§ˆí¬ í† ê¸€ ì‹¤íŒ¨:", err));
}

// ì¢‹ì•„ìš” í† ê¸€
function toggleLike(id) {
    axiosInstance.post(`/interaction/likes/${id}/toggle/`)
        .then(res => {
            const { is_liked, like_count } = res.data;
            const btn = document.querySelector(`.likeBtn[data-id="${id}"]`);
            if (btn) btn.innerHTML = `<span class="icon">${is_liked ? 'ğŸ’”' : 'â¤ï¸'}</span> <span class="count">${like_count}</span>`;
        })
        .catch(err => console.error("ì¢‹ì•„ìš” í† ê¸€ ì‹¤íŒ¨:", err));
}
</script>

{% endblock %}
